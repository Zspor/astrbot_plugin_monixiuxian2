# AstrBot 插件：文字修仙

**版本:** 1.0.3dev
**许可证:** AGPL-3.0

# 请检查文档后再决定是否更新，原版本不再维护更新，如需游玩，请去 **原作者**: [oldPeter616](https://github.com/oldPeter616)

一款基于 AstrBot 设计的文字修仙游戏插件。经过v1.0重构，现提供完整的修仙成长体验，包含角色创建、属性成长、装备系统、突破系统等核心玩法。

---

## 🎮 核心玩法

### 1. 角色系统
- **创建角色**：随机获得17种灵根之一，决定修炼速度
- **双修炼路线**：灵修（法术路线）/ 体修（肉身路线）
- **随机初始属性**：每个角色都有独特的初始属性

### 2. 成长系统
- **境界系统**：36个境界，从炼气期一层到混元大罗金仙
- **闭关修炼**：离线积累修为
- **突破境界**：消耗修为突破，成功率递减，失败有死亡风险

### 3. 装备系统
- **四大装备栏**：武器、防具、主修心法、功法（最多3个）
- **九大品级**：凡品 → 灵品 → 地品 → 天品 → 皇品 → 帝品 → 道品 → 仙品 → 混元先天
- **属性加成**：装备提供法伤、物伤、法防、物防、精神力等属性

### 4. 突破系统
- **破境丹辅助**：使用破境丹提升突破成功率
- **属性永久增长**：突破成功获得大量属性提升
- **死亡惩罚**：突破失败有概率死亡，数据全部清空

---

## 📌 v1.0 重构亮点

### 🔄 全新属性系统
- **增量式成长**：突破时属性累加而非覆盖，保留初始化的随机属性
- **双修炼差异**：灵修和体修的初始属性差异会永久保留
- **境界增量配置**：level_config.json 改为记录每次突破的属性增量

### ⚔️ 装备系统
- **多样化装备**：支持武器、防具、心法系统
- **心法加成**：主修心法影响修炼速度
- **装备品级**：与境界联动的装备等级系统

### 💊 突破系统
- **破境丹机制**：11种破境丹，从筑基丹到大罗金仙丹
- **成功率上限**：高级破境丹有成功率上限限制
- **死亡机制**：失败有1%-10%概率死亡

### 🔢 数据库重构
- **版本控制**：v5 数据库，支持增量迁移
- **装饰器迁移**：`@migration(version)` 模式
- **完整玩家数据**：保存所有属性、装备、修炼状态

---

## 🎯 游戏指令

| 指令 | 功能 | 说明 |
|-----|------|-----|
| `修仙帮助` | 显示帮助 | 查看所有可用命令 |
| `我要修仙` | 创建角色 | 随机获得灵根，每个QQ号限一次 |
| `我的信息` | 查看信息 | 显示境界、灵根、属性、装备等 |
| `闭关` | 开始闭关 | 开始离线修炼 |
| `出关` | 结束闭关 | 结算修为收益 |
| `签到` | 每日签到 | 领取灵石奖励 |
| `我的装备` | 查看装备 | 显示所有已装备物品 |
| `装备 [物品名]` | 装备物品 | 穿戴装备或心法 |
| `卸下 [物品名]` | 卸下装备 | 卸下指定装备 |
| `突破信息` | 查看突破 | 查看下一境界信息和成功率 |
| `突破 [丹药名]` | 尝试突破 | 突破到下一境界（可选使用丹药） |
| `储物戒` | 查看储物戒 | 查看储物戒信息和存储物品 |
| `存入 [物品名] [数量]` | 存入物品 | 将物品存入储物戒（丹药除外） |
| `取出 [物品名] [数量]` | 取出物品 | 从储物戒取出物品 |
| `更换储物戒 [储物戒名]` | 升级储物戒 | 替换为更高容量的储物戒 |

---

## ⚙️ 配置说明

### 访问控制
在 AstrBot 插件配置界面中设置白名单：
- **白名单群号列表**：留空则所有群聊可用
- 私聊永远可用

### 核心数值
- **初始灵石**：新玩家创建时获得的灵石数量（默认100）
- **闭关基础修为**：每分钟获得的基础修为（默认100）
- **签到奖励**：每日签到获得的灵石范围（50-500）
- **突破死亡概率**：突破失败的死亡概率范围（1%-10%）

### 灵根配置
- **修炼速度倍率**：17种灵根的修炼速度（0.5x - 2.5x）
- **抽取权重**：控制各种灵根的稀有度

---

## 🏗️ 技术架构

### 四层架构
```
1. 入口层 (main.py)
   └─ 插件注册、命令路由、访问控制

2. 处理器层 (handlers/)
   ├─ player_handler.py      # 玩家操作
   ├─ equipment_handler.py   # 装备系统
   ├─ breakthrough_handler.py # 突破系统
   └─ misc_handler.py        # 帮助信息

3. 业务逻辑层 (core/)
   ├─ cultivation_manager.py    # 修炼系统
   ├─ equipment_manager.py      # 装备管理
   └─ breakthrough_manager.py   # 突破管理

4. 数据层 (data/)
   ├─ data_manager.py        # 数据库操作
   └─ migration.py           # 数据库迁移
```

### 数据库
- **类型**：SQLite + aiosqlite (异步)
- **当前版本**：v10
- **迁移系统**：装饰器模式，支持增量升级

### 配置文件
```
config/
├── level_config.json     # 36境界配置（增量模式）
├── weapons.json          # 武器库（大量武器）
├── pills.json            # 丹药配置（破境丹）
├── items.json            # 其他物品
├── bosses.json           # Boss配置
└── tags.json             # 标签系统
```

---

## 🌟 灵根系统

### 17种灵根类型

| 类别 | 灵根 | 修炼速度 | 稀有度 |
|------|-----|---------|--------|
| 废柴 | 伪灵根 | 0.5x | 极少 |
| 多灵根 | 四/三/双灵根 | 0.6x-0.9x | 常见 |
| 五行单灵根 | 金/木/水/火/土 | 1.0x | 普通 |
| 变异灵根 | 雷/冰/风/暗/光 | 1.25x-1.3x | 稀有 |
| 天灵根 | 天金/天木等 | 1.5x | 极品 |
| 传说级 | 阴阳/融合 | 1.8x | 传说 |
| 神话级 | 混沌灵根 | 2.0x | 神话 |
| 禁忌级 | 先天道体/神圣体质 | 2.3x-2.5x | 禁忌 |

---

## 📊 境界体系

**36个境界**（index 0-35）：

```
炼气期：0-9     (10层)
筑基期：10-12   (初/中/后期)
金丹期：13-15
元婴期：16-18
化神期：19-21
炼虚期：22-24
合体期：25-27
大乘期：28-30
渡劫期：31
地仙：32
天仙：33
大罗金仙：34
混元大罗金仙：35
```

每次突破获得固定的属性增量，越高境界增量越大。

---

## 🎁 突破增量示例

| 突破 | 寿命 | 灵气 | 精神力 | 物伤/法伤 | 物防/法防 |
|-----|------|------|--------|----------|----------|
| 炼气一→二 | +50 | +10 | +10 | +3 | +1 |
| 炼气十→筑基初 | +50 | +180 | +180 | +27 | +14 |
| 筑基后→金丹初 | +50 | +650 | +650 | +130 | +65 |

---

## 🔧 开发相关

### 环境要求
- Python 3.8+
- AstrBot 框架
- aiosqlite

### 项目结构
```
astrbot_plugin_monixiuxian/
├── main.py                  # 插件入口
├── models.py                # 数据模型
├── config_manager.py        # 配置管理
├── _conf_schema.json        # 配置Schema
├── handlers/                # 命令处理器
├── core/                    # 业务逻辑
├── data/                    # 数据访问层
└── config/                  # 游戏配置文件
```

### 技术特点
- ✅ 全异步架构（async/await）
- ✅ 异步生成器模式（async for yield）
- ✅ 装饰器驱动的数据库迁移
- ✅ 数据类模型（dataclass）
- ✅ 配置化的游戏数值

---

## 📜 更新日志

### v1.0.2dev
- 🗄️ **数据库迁移 v10**：自动清理废弃字段（equipment_inventory），修复启动报错
- 📝 **境界显示优化**：装备/丹药/突破的境界需求改为显示境界名称（如"筑基期一层"）而非索引
- 🔧 **旧物品格式兼容**：支持 items.json 中旧格式法器（equip_effects）和丹药（legacy_pill）
- 🏪 **商店系统增强**：新增 legacy_pill、material、accessory 类型处理
- 🐛 **修复**：Player 模型字段过滤兼容旧数据库结构

### v1.0.1dev
- ⚙️ 体修支持完善：新增体修境界配置、气血属性（blood_qi/max_blood_qi），突破与修炼流程按修炼类型读取对应配置
- 🩺 丹药与属性安全：体修气血的瞬时/持续恢复、复活减半、永久丹药上限均生效，属性下限强制不为负
- 🛒 商店批量购买：购买指令支持“物品名 数量”，库存校验防止超买；装备仍单件购买
- 🗄️ 数据库迁移：新增 v9 迁移添加气血字段，保持老数据升级


## 🤝 贡献

欢迎通过 Issue 或 Pull Request 贡献代码、报告 Bug 或提出建议。

---

## 📄 许可证

本插件采用 **AGPL-3.0** 许可证。

---

## 🙏 致谢

- **原作者**: [oldPeter616](https://github.com/oldPeter616)
- **维护者**: [linjianyan0229](https://github.com/linjianyan0229)
- **架构设计**: [@Zhalslar](https://github.com/Zhalslar)

---

## 🔗 相关链接

- **GitHub仓库**: https://github.com/linjianyan0229/astrbot_plugin_monixiuxian
- **AstrBot框架**: https://github.com/Soulter/AstrBot
- **问题反馈**: https://github.com/linjianyan0229/astrbot_plugin_monixiuxian/issues
